FROM ubuntu:24.04 AS base

WORKDIR /workspace/

ENV PATH="/root/.local/bin:$PATH"
ENV VIRTUAL_ENV="/opt/venv"
ENV UV_PYTHON_INSTALL_DIR="/opt/uv/python"
ENV PATH="$VIRTUAL_ENV/bin:$PATH"

ENV UV_HTTP_TIMEOUT=500

ENV UV_INDEX_STRATEGY="unsafe-best-match"
ENV UV_LINK_MODE="copy"

RUN <<EOF
#!/bin/bash

install_deps() {
  apt-get update -y
  apt-get install -y --no-install-recommends git curl wget ca-certificates \
    gcc g++ libtcmalloc-minimal4 libnuma-dev ffmpeg libsm6 libxext6 libgl1 jq \
    lsof vim numactl
  curl -LsSf https://astral.sh/uv/0.7.21/install.sh | bash
  rm -rf /var/lib/apt/lists/*

  echo "LD_PRELOAD=/usr/lib/$arch-linux-gnu/libtcmalloc_minimal.so.4" >> /etc/environment
  echo 'ulimit -c 0' >> ~/.bashrc
}

pip_install() {
  local url="https://download.pytorch.org/whl/cpu"
  uv pip install -v -r $1 --extra-index-url $url
}

main() {
  set -eux -o pipefail

  local arch=$(uname -m)
  install_deps

  uv venv --python 3.12 --seed ${VIRTUAL_ENV}
  uv pip install --upgrade pip

  local v_vn="0.9.2"
  local vllm_url="https://github.com/vllm-project/vllm"
  curl -LsSf $vllm_url/releases/download/v$v_vn/vllm-$v_vn.tar.gz | tar xz
  cd vllm-$v_vn
  if [ "$arch" == "x86_64" ]; then
    export VLLM_CPU_DISABLE_AVX512="0"
    export VLLM_CPU_AVX512BF16="0"
    export VLLM_CPU_AVX512VNNI="0"
  elif [ "$arch" == "aarch64" ]; then
    export VLLM_CPU_DISABLE_AVX512="true"
  fi

  pip_install requirements/cpu-build.txt
  pip_install requirements/cpu.txt
  VLLM_TARGET_DEVICE=cpu python3 setup.py install
  cd -
  rm -rf vllm-$v_vn /root/.cache
}

main "$@"
EOF

